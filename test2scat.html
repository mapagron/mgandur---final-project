<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TEST: Stackbar </title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <style>
  </style>
</head>
<body>
    <div class="header section">
      <div class="container">
        <h1>Colombia</h1>
        <p> (2000 - 2016)</p>
      </div>
    </div>
    <div class= "description problem">
        <div class="description">
          <p> August 07 - 1. check the scale (something is wrong with it) </p>
          <hr>
          <p> </p>
        </div>
    </div>
    <div class="controls section">
      <div class="container">
        <div class="btn-toolbar">
          <label for="Department">Department </label>
          <select id="department">
            <option value="all">All</option>
            <option value="Amazonas">Amazonas</option>
            <option value="Antioquia">Antioquia</option>
            <option value="Arauca">Arauca</option>
            <option value="Atlantico">Atlantico</option>
            <option value="Bolivar">Bolivar</option>
            <option value="Boyaca">Boyacá</option>
            <option value="Caldas">Caldas</option>
            <option value="Caqueta">Caqueta</option>
            <option value="Casanare">Casanare</option>
            <option value="Cauca">Cauca</option>
            <option value="Cesar">Cesar</option>
            <option value="Choco">Choco</option>
            <option value="Cordoba">Cordoba</option>
            <option value="Cundinamarca">Cundinamarca</option>
            <option value="Guainia">Guainia</option>
            <option value="Guaviare">Guaviare</option>
            <option value="Huila">Huila</option>
            <option value="Magdalena">Magdalena</option>
            <option value="Meta">Meta</option>
            <option value="Nariño">Nariño</option>
            <option value="Norte de Santander">Norte de Santander</option>
            <option value="Putumayo">Putumayo</option>
            <option value="Quindio">Quindio</option>
            <option value="Risaralda">Risaralda</option>
            <option value="San Andres">San Andres</option>
            <option value="Santander">Santander</option>
            <option value="Sucre">Sucre</option>
            <option value="Tolima">Tolima</option>
            <option value="Valle">Valle</option>
            <option value="Vaupes">Vaupes</option>
            <option value="Vichada">Vichada</option>
          </select>
        </div>
      </div>
    </div>
    <div class="main section">
      <div class="container">
        <div id="chart"></div>
        </div>
    </div>
    <script type="text/javascript" src="https://npmcdn.com/d3@3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://npmcdn.com/d3-tip@0.6.7/index.js"></script>
    <script>
      
      var txData = [];
      var filteredData = [];
      var groupedData = [];
      var genders = ["feminine" ,"masculine"];

      var margin = {top: 20, right: 50, bottom: 30, left: 50},
              width = 600 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;
       
      var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .35);
       
      var y = d3.scale.linear()
              .rangeRound([height, 0]);
       
      var color = d3.scale.category20();
       
      var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");
       
      var svg;


      // Calling the data 
      d3.csv('gender.csv', function (error, json) {
        if (error) { throw error; }
        data = json;
        
        setup();
        update("all");
      });

        

      function setup() {
      
        // SVG
        svg = d3.select('#chart')
          .append('svg')
          .attr('width', width)
          .attr('height', height);
    
        // SCALES
        var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .35);
       
        var y = d3.scale.linear()
              .rangeRound([height, 0]);
    
        // AXES
        // EVENT HANDLERS


        // Set the event handler for selecting a department
        d3.select('#department').on('change', function () {

          var department = d3.event.target.value;
          update(department);
        });
      }

      function update(department) {
        // TRANSFORM
        svg.selectAll( "*" ).remove( );
        
        // Filter the data
        filteredData = data.slice();

        if( department !== "all" )
        {
          //console.log(filteredData);
          
          // Get the data for one department
          filteredData = filteredData.filter( function (data) {
            return ( data.department == department );
          });
        }

        // Group the data by felonies and gender
        groupedData = genders.map(function (c) {
          return filteredData.map(function (d) {
            return {x: d.felony, y: d[c]};
          });
        });
          
        // TESTING - STACK 

        console.log( groupedData);
        // the data is grouped correctly 

        var barChart = d3.layout.stack()(groupedData);
         
        x.domain(barChart[0].map(function (d) {
            return d.x;
        }));

        y.domain([0,
            d3.max(barChart[barChart.length - 1],
                    function (d) { return d.y0 + d.y;})
            ])
          .nice();
         
        var layer = svg.selectAll(".stack")
                .data(barChart)
                .enter().append("g")
                .attr("class", "stack")
                .style("fill", function (d, i) {
                    return color(i);
                });
         
        layer.selectAll("rect")
                .data(function (d) {
                    return d;
                })
                .enter().append("rect")
                .attr("x", function (d) {
                    return x(d.x);
                })
                .attr("y", function (d) {
                    return y(d.y + d.y0);
                })
                .attr("height", function (d) {
                    return y(d.y0) - y(d.y + d.y0);
                })
                .attr("width", x.rangeBand());
         
        svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);
        
      }
      
    </script>
  </body>
</html>